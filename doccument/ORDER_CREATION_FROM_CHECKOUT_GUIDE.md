# üõçÔ∏è ORDER CREATION FROM CHECKOUT SESSION - CHI TI·∫æT LU·ªíNG MUA H√ÄNG

## üìå **T·ªîNG QUAN**

Document n√†y m√¥ t·∫£ chi ti·∫øt **lu·ªìng mua h√†ng** t·ª´ Checkout Session sang Order, bao g·ªìm t·∫•t c·∫£ c√°c **edge case th·ª±c t·∫ø** m√† h·ªá th·ªëng ph·∫£i handle.

---

## üéØ **LU·ªíNG MUA H√ÄNG T·ªîNG TH·ªÇ**

```mermaid
graph TD
    A[User nh·∫•n ƒê·∫∑t h√†ng] --> B[Validate Session]
    B --> C{Session h·ª£p l·ªá?}
    C -->|Kh√¥ng| D[Tr·∫£ v·ªÅ l·ªói c·ª• th·ªÉ]
    C -->|C√≥| E[Lock Session]
    E --> F[Validate Items realtime]
    F --> G{Items c√≥ v·∫•n ƒë·ªÅ?}
    G -->|C√≥| H[Tr·∫£ v·ªÅ l·ªói items]
    G -->|Kh√¥ng| I[Validate Vouchers realtime]
    I --> J{Vouchers OK?}
    J -->|Kh√¥ng| K[Tr·∫£ v·ªÅ l·ªói vouchers]
    J -->|OK| L[T·∫°o OrderRequest]
    L --> M[G·ªçi OrderService.create]
    M --> N{Order t·∫°o th√†nh c√¥ng?}
    N -->|Kh√¥ng| O[Ph√¢n t√≠ch l·ªói + Return]
    N -->|C√≥| P[Mark Session Completed]
    P --> Q[Return Order ID]
```

---

## üîç **CHI TI·∫æT C√ÅC B∆Ø·ªöC VALIDATION**

### **1. SESSION VALIDATION**

#### **Ki·ªÉm tra Session Active:**
```java
if (!session.isActive()) {
    if (session.isExpired()) {
        return "Phi√™n checkout ƒë√£ h·∫øt h·∫°n. Vui l√≤ng t·∫°o phi√™n m·ªõi.";
    } else {
        return "Phi√™n checkout kh√¥ng h·ª£p l·ªá.";
    }
}
```

#### **Ki·ªÉm tra ƒë·ªãa ch·ªâ giao h√†ng:**
```java
if (session.getAddress() == null) {
    return "Ch∆∞a ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng.";
}
```

### **2. ITEMS VALIDATION REALTIME**

#### **Ki·ªÉm tra s√°ch t·ªìn t·∫°i v√† status:**
```java
Book book = bookRepository.findById(item.getBookId());
if (book.getStatus() != 1) {
    return "S√°ch '" + book.getBookName() + "' ƒë√£ ng·ª´ng b√°n";
}
```

#### **Ki·ªÉm tra stock th√¥ng th∆∞·ªùng:**
```java
if (book.getStockQuantity() < item.getQuantity()) {
    return "S√°ch '" + book.getBookName() + "' ch·ªâ c√≤n " + book.getStockQuantity() + " cu·ªën trong kho";
}
```

#### **Ki·ªÉm tra thay ƒë·ªïi gi√° (Race condition):**
```java
BigDecimal currentPrice = getCurrentPrice(item);
if (item.getUnitPrice().compareTo(currentPrice) != 0) {
    return "Gi√° s√°ch '" + book.getBookName() + "' ƒë√£ thay ƒë·ªïi. Vui l√≤ng c·∫≠p nh·∫≠t l·∫°i gi·ªè h√†ng";
}
```

### **3. FLASH SALE VALIDATION**

#### **Ki·ªÉm tra Flash Sale c√≤n active:**
```java
FlashSale flashSale = flashSaleItem.getFlashSale();
long currentTime = System.currentTimeMillis();

if (flashSale.getStatus() != 1) {
    return "Flash sale cho s√°ch '" + book.getBookName() + "' ƒë√£ b·ªã t·∫Øt";
}

if (currentTime > flashSale.getEndTime()) {
    return "Flash sale cho s√°ch '" + book.getBookName() + "' ƒë√£ k·∫øt th√∫c";
}
```

#### **Ki·ªÉm tra stock Flash Sale:**
```java
if (flashSaleItem.getStockQuantity() < item.getQuantity()) {
    return "Flash sale cho s√°ch '" + book.getBookName() + "' ch·ªâ c√≤n " + flashSaleItem.getStockQuantity() + " cu·ªën";
}
```

### **4. VOUCHER VALIDATION**

#### **Ki·ªÉm tra voucher h·∫øt h·∫°n ƒë√∫ng l√∫c ƒë·∫∑t h√†ng:**
```java
long currentTime = System.currentTimeMillis();
if (currentTime > voucher.getEndTime()) {
    return "Voucher '" + voucher.getCode() + "' ƒë√£ h·∫øt h·∫°n";
}
```

#### **Ki·ªÉm tra ƒë∆°n t·ªëi thi·ªÉu:**
```java
if (voucher.getMinOrderValue() != null && 
    session.getSubtotal().compareTo(voucher.getMinOrderValue()) < 0) {
    return "Voucher '" + voucher.getCode() + "' y√™u c·∫ßu ƒë∆°n h√†ng t·ªëi thi·ªÉu " + voucher.getMinOrderValue();
}
```

#### **Ki·ªÉm tra usage limit:**
```java
if (voucher.getUsageLimit() != null && voucher.getUsedCount() >= voucher.getUsageLimit()) {
    return "Voucher '" + voucher.getCode() + "' ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng";
}
```

---

## ‚ö†Ô∏è **T·∫§T C·∫¢ EDGE CASES TH·ª∞C T·∫æ**

### **1. RACE CONDITIONS**

#### **Case: 2 user c√πng mua item cu·ªëi c√πng**
- **Gi·∫£i ph√°p:** Lock session khi t·∫°o order
- **Behavior:** User ƒë·∫ßu th√†nh c√¥ng, user sau b√°o h·∫øt h√†ng

#### **Case: Flash sale k·∫øt th√∫c ƒë√∫ng l√∫c ƒë·∫∑t h√†ng**
- **Detection:** Check `currentTime > flashSale.getEndTime()`
- **Response:** "Flash sale cho s√°ch 'X' ƒë√£ k·∫øt th√∫c"

#### **Case: Voucher h·∫øt h·∫°n trong l√∫c user ƒëang checkout**
- **Detection:** Check realtime t·∫°i th·ªùi ƒëi·ªÉm t·∫°o order
- **Response:** "Voucher 'CODE' ƒë√£ h·∫øt h·∫°n"

### **2. INVENTORY ISSUES**

#### **Case: S√°ch h·∫øt h√†ng sau khi add v√†o session**
```java
if (book.getStockQuantity() < item.getQuantity()) {
    return "‚ùå S√°ch '" + book.getBookName() + "' ch·ªâ c√≤n " + book.getStockQuantity() + " cu·ªën trong kho";
}
```

#### **Case: Flash sale h·∫øt stock**
```java
if (flashSaleItem.getStockQuantity() < item.getQuantity()) {
    return "‚ùå Flash sale cho s√°ch '" + book.getBookName() + "' ch·ªâ c√≤n " + flashSaleItem.getStockQuantity() + " cu·ªën";
}
```

#### **Case: S√°ch b·ªã ng·ª´ng b√°n ƒë·ªôt ng·ªôt**
```java
if (book.getStatus() != 1) {
    return "‚ùå S√°ch '" + book.getBookName() + "' ƒë√£ ng·ª´ng b√°n";
}
```

### **3. PRICING ISSUES**

#### **Case: Gi√° thay ƒë·ªïi gi·ªØa session v√† order**
```java
BigDecimal currentPrice = getCurrentPrice(item);
if (item.getUnitPrice().compareTo(currentPrice) != 0) {
    return "‚ùå Gi√° s√°ch '" + book.getBookName() + "' ƒë√£ thay ƒë·ªïi t·ª´ " + item.getUnitPrice() + " th√†nh " + currentPrice;
}
```

#### **Case: Flash sale price thay ƒë·ªïi**
```java
BigDecimal currentFlashPrice = getCurrentFlashSalePrice(item.getFlashSaleItemId());
if (currentFlashPrice == null) {
    return "‚ùå Flash sale cho s√°ch '" + book.getBookName() + "' ƒë√£ k·∫øt th√∫c";
}
```

### **4. VOUCHER COMPLEX CASES**

#### **Case: Voucher conflict (1 user, multiple sessions)**
```java
if (!voucherCalculationService.canUserUseVoucher(userId, voucherId)) {
    return "‚ùå B·∫°n ƒë√£ s·ª≠ d·ª•ng h·∫øt l∆∞·ª£t cho voucher '" + voucher.getCode() + "'";
}
```

#### **Case: Multi-voucher validation**
```java
// Ki·ªÉm tra t·ªïng discount c√≥ v∆∞·ª£t qu√° max kh√¥ng
// Ki·ªÉm tra voucher type conflicts (shipping vs product)
```

#### **Case: Voucher minimum order change**
```java
// Khi user remove items kh·ªèi session ‚Üí subtotal gi·∫£m ‚Üí voucher kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán
if (session.getSubtotal().compareTo(voucher.getMinOrderValue()) < 0) {
    return "‚ùå ƒê∆°n h√†ng kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán cho voucher '" + voucher.getCode() + "'";
}
```

### **5. SESSION EXPIRY CASES**

#### **Case: Session h·∫øt h·∫°n ƒë√∫ng l√∫c ƒë·∫∑t h√†ng**
```java
if (session.isExpired()) {
    return "‚ùå Phi√™n checkout ƒë√£ h·∫øt h·∫°n. Vui l√≤ng t·∫°o phi√™n m·ªõi.";
}
```

#### **Case: Session b·ªã completed b·ªüi request kh√°c**
```java
if (session.getStatus() == 2) {
    return "‚ùå ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t t·ª´ phi√™n n√†y r·ªìi.";
}
```

---

## üéØ **API ENDPOINT DETAILS**

### **POST /api/checkout-sessions/{sessionId}/create-order**

#### **Request:**
```http
POST /api/checkout-sessions/123/create-order?userId=456
Content-Type: application/json
```

#### **Success Response (201):**
```json
{
  "status": 201,
  "message": "ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ORD20250711001",
  "data": 12345
}
```

#### **Error Responses:**

**400 - Session Issues:**
```json
{
  "status": 400,
  "message": "‚ùå Phi√™n checkout ƒë√£ h·∫øt h·∫°n. Vui l√≤ng t·∫°o phi√™n m·ªõi.",
  "data": null
}
```

**400 - Stock Issues:**
```json
{
  "status": 400,
  "message": "‚ùå S√°ch 'Clean Code' ch·ªâ c√≤n 2 cu·ªën trong kho",
  "data": null
}
```

**400 - Flash Sale Issues:**
```json
{
  "status": 400,
  "message": "‚ùå Flash sale cho s√°ch 'Spring Boot' ƒë√£ k·∫øt th√∫c",
  "data": null
}
```

**400 - Voucher Issues:**
```json
{
  "status": 400,
  "message": "‚ùå Voucher 'WELCOME10' ƒë√£ h·∫øt h·∫°n",
  "data": null
}
```

**400 - Price Change:**
```json
{
  "status": 400,
  "message": "‚ùå Gi√° s√°ch 'Java Programming' ƒë√£ thay ƒë·ªïi. Vui l√≤ng c·∫≠p nh·∫≠t l·∫°i gi·ªè h√†ng",
  "data": null
}
```

**404 - Session Not Found:**
```json
{
  "status": 404,
  "message": "Kh√¥ng t√¨m th·∫•y checkout session",
  "data": null
}
```

**500 - System Error:**
```json
{
  "status": 500,
  "message": "L·ªói h·ªá th·ªëng khi t·∫°o ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.",
  "data": null
}
```

---

## üîß **IMPLEMENTATION DETAILS**

### **Synchronization Strategy:**
```java
// Lock session khi t·∫°o order ƒë·ªÉ tr√°nh race condition
synchronized (this) {
    // Double-check session v·∫´n c√≤n active
    session = getSessionEntity(sessionId, userId);
    if (session == null || !session.isActive()) {
        return new ApiResponse<>(400, "Session ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng kh·∫£ d·ª•ng", null);
    }
    
    // Process order creation...
}
```

### **Error Classification:**
```java
private String analyzeOrderCreationError(String originalError, CheckoutSession session) {
    String lowerError = originalError.toLowerCase();
    
    if (lowerError.contains("stock")) {
        return "‚ùå M·ªôt s·ªë s·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng. Vui l√≤ng c·∫≠p nh·∫≠t l·∫°i gi·ªè h√†ng.";
    }
    
    if (lowerError.contains("flash sale")) {
        return "‚ùå Flash sale ƒë√£ k·∫øt th√∫c ho·∫∑c h·∫øt h√†ng. Vui l√≤ng ki·ªÉm tra l·∫°i.";
    }
    
    if (lowerError.contains("voucher")) {
        return "‚ùå Voucher kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ki·ªÉm tra l·∫°i.";
    }
    
    if (lowerError.contains("price")) {
        return "‚ùå Gi√° s·∫£n ph·∫©m ƒë√£ thay ƒë·ªïi. Vui l√≤ng c·∫≠p nh·∫≠t l·∫°i ƒë∆°n h√†ng.";
    }
    
    return "‚ùå " + originalError;
}
```

---

## üéØ **FRONTEND INTEGRATION**

### **Complete Order Flow:**
```javascript
const handleCreateOrder = async (sessionId, userId) => {
  try {
    // 1. Show loading
    setLoading(true);
    setError(null);
    
    // 2. Validate session tr∆∞·ªõc (optional - ƒë·ªÉ UX t·ªët h∆°n)
    const validateResult = await validateSession(sessionId, userId);
    if (validateResult.status !== 200) {
      setError(validateResult.message);
      return;
    }
    
    // 3. T·∫°o order
    const orderResult = await createOrderFromSession(sessionId, userId);
    
    if (orderResult.status === 201) {
      // Success: Navigate to order success page
      router.push(`/order-success/${orderResult.data}`);
    } else {
      // Error: Show specific error message
      setError(orderResult.message);
      
      // N·∫øu l√† l·ªói stock/price ‚Üí redirect v·ªÅ cart ƒë·ªÉ update
      if (orderResult.message.includes('h·∫øt h√†ng') || orderResult.message.includes('thay ƒë·ªïi')) {
        setTimeout(() => {
          router.push('/cart');
        }, 3000);
      }
    }
    
  } catch (error) {
    console.error('Order creation error:', error);
    setError('L·ªói h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i sau.');
  } finally {
    setLoading(false);
  }
};
```

### **Error Handling Strategy:**
```javascript
const handleOrderError = (errorMessage) => {
  // Ph√¢n lo·∫°i l·ªói v√† x·ª≠ l√Ω t∆∞∆°ng ·ª©ng
  if (errorMessage.includes('h·∫øt h·∫°n')) {
    // Session expired ‚Üí T·∫°o session m·ªõi t·ª´ cart
    showDialog({
      title: 'Phi√™n h·∫øt h·∫°n',
      message: 'Phi√™n checkout ƒë√£ h·∫øt h·∫°n. Ch√∫ng t√¥i s·∫Ω t·∫°o phi√™n m·ªõi cho b·∫°n.',
      onConfirm: () => createNewSessionFromCart()
    });
  } else if (errorMessage.includes('h·∫øt h√†ng')) {
    // Stock issue ‚Üí Redirect to cart
    showDialog({
      title: 'S·∫£n ph·∫©m h·∫øt h√†ng',
      message: errorMessage + '\n\nB·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ gi·ªè h√†ng ƒë·ªÉ c·∫≠p nh·∫≠t.',
      onConfirm: () => router.push('/cart')
    });
  } else if (errorMessage.includes('thay ƒë·ªïi')) {
    // Price change ‚Üí Refresh session
    showDialog({
      title: 'Gi√° thay ƒë·ªïi',
      message: errorMessage + '\n\nVui l√≤ng ki·ªÉm tra l·∫°i ƒë∆°n h√†ng.',
      onConfirm: () => refreshSession()
    });
  } else {
    // Generic error
    showError(errorMessage);
  }
};
```

---

## üìä **MONITORING & ANALYTICS**

### **Key Metrics to Track:**
- Order creation success rate t·ª´ checkout session
- Most common validation errors
- Average time from session creation to order
- Session expiry rate vs order conversion

### **Logging Strategy:**
```java
// Log success
log.info("‚úÖ Successfully created order: {} from session: {}", orderId, sessionId);

// Log validation failures
log.warn("Session validation failed for session {}: {}", session.getId(), errorMessage);

// Log critical errors
log.error("üí• Critical error creating order from session: {}", sessionId, e);
```

---

## üîí **SECURITY CONSIDERATIONS**

1. **Session Ownership:** Ch·ªâ user s·ªü h·ªØu session m·ªõi c√≥ th·ªÉ t·∫°o order
2. **Idempotency:** Tr√°nh duplicate orders t·ª´ c√πng 1 session
3. **Rate Limiting:** Gi·ªõi h·∫°n s·ªë l·∫ßn t·∫°o order m·ªói user/th·ªùi gian
4. **Data Validation:** Validate t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ session tr∆∞·ªõc khi t·∫°o order

---

*üìù Document n√†y cover t·∫•t c·∫£ c√°c tr∆∞·ªùng h·ª£p th·ª±c t·∫ø c√≥ th·ªÉ x·∫£y ra trong qu√° tr√¨nh mua h√†ng. Update khi c√≥ th√™m edge cases m·ªõi.*
